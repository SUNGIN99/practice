branches:
  only:
    - master

services:
  - docker

jobs:
  include:
    - stage: SpringBoot gradle build & Build Gradle Docker Image
      language: java
      jdk:
        - openjdk11

      #cache:
      #  directories:
      #    - '$HOME/ .m2/repository'
      #    - '$HOME/ .gradle'
      before_install:
        - chmod +x gradlew
      script:
        - ./gradlew clean build
        - docker build -t $SPRING_REPO -f ./Dockerfile .
        - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
        - docker push $SPRING_REPO

    - stage: Build Nginx Docker image
      sudo: required
      language: generic
      script:
        - docker build -t $NGINX_REPO -f ./Dockerfile-nginx .
        - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
        - docker push $NGINX_REPO

    - stage: Deploy Stage
      language: generic

      before_deploy:
        - mkdir before-deploy
        - cp ./docker-compose.yaml before-deploy
        - cp ./appspec.yml before-deploy
        - cp ./scripts/docker-hub.sh before-deploy
        - cd before-deploy && zip -r prac-built *
        - cd ../ && mkdir -p deploy
        - mv before-deploy/prac-built.zip deploy/prac-built.zip
      after_deploy:
        - wget https://raw.githubusercontent.com/DiscordHooks/travis-ci-discord-webhook/master/send.sh
        - chmod +x send.sh
        - ./send.sh success $WEBHOOK_URL
      deploy:
        - provider: s3
          access_key_id: $AWS_ACCESS_KEY
          secret_access_key: $AWS_ACCESS_SECRET
          bucket: practice-build
          region: ap-northeast-2
          skip_cleanup: true
          acl: private
          local_dir: deploy
          wait-until-deployed: true

        - provider: codedeploy
          access_key_id: $AWS_ACCESS_KEY
          secret_access_key: $AWS_ACCESS_SECRET
          bucket: practice-build
          key: prac-built.zip
          bundle_type: zip
          application: practiceservice
          deployment_group: practiceservice-group
          region: ap-northeast-2
          wait-until-deployed: true




